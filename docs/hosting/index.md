# Deploying Mirlo to a VPS

This guide covers deploying Mirlo to a clean Virtual Private Server (VPS). It includes instructions for Docker-based deployments, bare-metal installations, and platform-specific guidance for DigitalOcean.

## Architecture Overview

Mirlo consists of several components:

- **API Server** (Node.js/Express) - REST API and frontend serving
- **Database** (PostgreSQL) - User data, tracks, artists, etc.
- **Cache** (Redis) - Job queue and session management
- **File Storage** (MinIO) - S3-compatible storage for media files
- **Background Worker** (Node.js) - Async job processing (audio conversion, image optimization, email)

## Prerequisites

### System Requirements

- **OS**: Ubuntu 22.04 LTS or similar (recommended)
- **RAM**: Minimum 2GB (4GB+ recommended for production)
- **Storage**: 20GB+ free space (more for media files). We recommend setting up with a backblaze account.
- **CPU**: 1+ cores

### Required Tools

Depending on your deployment method:

**For Docker deployments:**

- Docker Engine 20.10+
- Docker Compose 2.0+

## Option 1: Docker Deployment (Recommended)

Docker deployment is the simplest approach and ensures consistency across environments.

### 1. Initial Setup

Connect to your VPS and create a deployment directory:

```bash
ssh root@your-vps-ip
mkdir -p /opt/mirlo
cd /opt/mirlo
```

### 2. Clone the Repository

```bash
git clone https://github.com/funmusicplace/mirlo.git .
```

### 3. Configure Environment Variables

Copy the example environment file and configure it:

```bash
cp .env.example .env
nano .env
```

Key variables to set:

```dotenv
# Basic Configuration
NODE_ENV=production
PORT=3000
API_DOMAIN=https://yourdomain.com
STATIC_MEDIA_HOST=https://yourdomain.com
REACT_APP_API_DOMAIN=https://yourdomain.com

# Security
JWT_SECRET=your-secure-jwt-secret-here
REFRESH_TOKEN_SECRET=your-secure-refresh-token-secret-here

# Database
DATABASE_URL="postgresql://mirlo_user:secure-password@pgsql:5432/mirlo?schema=public"
POSTGRES_USER=mirlo_user
POSTGRES_PASSWORD=secure-password

# Redis
REDIS_PASSWORD=secure-redis-password

###
# Choose one: MinIO or BackBlaze. BackBlaze is recommended in production.
###

# MinIO
MINIO_ROOT_USER=minioadmin
MINIO_ROOT_PASSWORD=secure-minio-password

# Backblaze B2
BACKBLAZE_KEY_ID=
BACKBLAZE_KEY_NAME=
BACKBLAZE_APP_KEY=
BACKBLAZE_REGION=
BACKBLAZE_ENDPOINT=

# Optional: Stripe Integration
STRIPE_KEY=your-stripe-key

```

Generate secure passwords:

```bash
openssl rand -base64 32
```

### 4. Update Docker Compose Configuration

Edit `docker-compose.api.yml` to set port mappings and storage paths:

### 5. Build and Start Services

```bash
docker compose up -d
```

Verify all services are running:

```bash
docker compose ps
```

You should see 5 services: api, background, pgsql, redis, minio

### 6. Initialize Database

Run migrations on first deployment:

```bash
docker compose exec api yarn prisma:migrate:deploy
```

Optionally seed with demo data:

```bash
docker compose exec api yarn prisma:seed
```

### 7. Setup Reverse Proxy (Nginx)

Mirlo should sit behind a reverse proxy for SSL/TLS and better performance.

Install Nginx:

```bash
apt-get update
apt-get install -y nginx certbot python3-certbot-nginx
```

Create Nginx configuration:

```bash
nano /etc/nginx/sites-available/mirlo
```

```nginx
server {
    server_name yourdomain.com www.yourdomain.com;
    listen 80;

    # Redirect HTTP to HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    server_name yourdomain.com www.yourdomain.com;
    listen 443 ssl http2;

    # SSL certificates (will be generated by certbot)
    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;

    # Security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;

    # Gzip compression
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;

    client_max_body_size 5G; # Allow large file uploads

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # Timeouts for large uploads
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }
}
```

Enable the site:

```bash
ln -s /etc/nginx/sites-available/mirlo /etc/nginx/sites-enabled/
nginx -t  # Test configuration
systemctl restart nginx
```

### 8. Setup SSL Certificate

```bash
certbot --nginx -d yourdomain.com -d www.yourdomain.com
```

Answer the prompts to complete SSL setup. Certbot will auto-renew certificates.

### 9. Verify Deployment

```bash
# Check application health
curl https://yourdomain.com/health

# View API logs
docker compose logs -f api

# View background worker logs
docker compose logs -f background

# Check MinIO web UI
# Open https://yourdomain.com:9001 in browser
```

### Maintenance & Updates

**View logs:**

```bash
docker compose logs api
docker compose logs background
```

**Restart services:**

```bash
docker compose restart api
docker compose restart background
```

**Update to latest version:**

```bash
git pull origin main
docker compose pull
docker compose up -d
docker compose exec api yarn prisma:migrate:deploy
```

**Backup database:**

```bash
docker compose exec pgsql pg_dump -U mirlo_user mirlo > /backup/mirlo-$(date +%Y%m%d).sql
```

## Common Tasks

### Viewing Logs

**Docker:**

```bash
docker compose logs -f api
docker compose logs -f background
docker compose logs pgsql | tail -100
```

### Database Backups

**Docker:**

```bash
docker compose exec pgsql pg_dump -U mirlo_user mirlo | gzip > /backups/mirlo-$(date +%Y%m%d).sql.gz
```

### Restoring from Backup

```bash
# Docker
gunzip < backup.sql.gz | docker compose exec -T pgsql psql -U mirlo_user mirlo

# Bare-metal
gunzip < backup.sql.gz | sudo -u postgres psql mirlo
```

### Updating Mirlo

**Docker:**

```bash
cd /opt/mirlo
git pull origin main
docker compose pull
docker compose up -d
docker compose exec api yarn prisma:migrate:deploy
```

### Monitoring

Install Prometheus and Grafana for monitoring (optional):

```bash
# Docker
docker run -d -p 9090:9090 prom/prometheus

# Bare-metal
apt-get install -y prometheus grafana-server
systemctl start grafana-server
# Access at localhost:3000
```

---

## Troubleshooting

### Service won't start

Check logs first:

```bash
# Docker
docker compose logs api
```

### Database connection errors

Verify connection string and credentials:

```bash
# Docker
docker compose exec api psql $DATABASE_URL
```

### File upload failures

Check MinIO is running and has adequate storage:

```bash
# Docker
docker compose ps minio
docker compose exec minio mc admin info local
```

### Out of memory errors

Increase available memory or Node.js heap:

```bash
# Docker - edit docker-compose.api.yml
environment:
  - NODE_OPTIONS=--max-old-space-size=2048
```

---

## Production Best Practices

1. **Backups**: Automate daily database backups to off-site storage
2. **Monitoring**: Setup alerts for disk space, CPU, memory, and service health
3. **Firewall**: Restrict access to internal ports (Redis, PostgreSQL)
4. **Updates**: Keep OS and dependencies updated regularly
5. **Logging**: Centralize logs using ELK, Syslog, or similar
6. **Rate Limiting**: Configure Nginx rate limiting for API endpoints
7. **Secrets Management**: Use OS-level secret management, never commit to git
8. **Testing**: Test backups and disaster recovery procedures
9. **Documentation**: Document your specific deployment configuration

---

## Getting Help

- [GitHub Issues](https://github.com/funmusicplace/mirlo/issues)
- [Documentation](https://mirlo.space/docs)
- [Render.yaml Reference](../render.yaml)
